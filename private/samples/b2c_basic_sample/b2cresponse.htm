<!DOCTYPE html>
<html> 
    <head><h3>Welcome</h3> 
    <style>
        html {
        display: table;
        margin: auto;
        }

        body {
            display: table-cell;
            vertical-align: middle;
        }
    </style>

    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jwt-decode/build/jwt-decode.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
            
    <script>
    function logout()
    {
         $.get("b2csettings.json", function(data){
             var getUrl = window.location;
             var baseUrl = getUrl.protocol + "//" + getUrl.host ;
             window.location = "https://login.microsoftonline.com/"+data.tenant_name+"/oauth2/v2.0/logout"+
             "?p="+data.policyName+
         "&post_logout_redirect_uri="+baseUrl+"/default.htm";
         });     

    }

    function getCode()
    {
        var hashVal = window.location.hash.substr(1);
        var code = hashVal.split('&')[1].substr(5);
        console.log(code);
        return code;
    }

    function decodeClaims()
    {
        var hashVal = window.location.hash.substr(1);
        var idToken = hashVal.split('&')[2].substr(9);
        console.log(idToken);
        var decoded = jwt_decode(idToken);
        console.log(decoded);
        return decoded;

    }

    function getErrorDetails()
    {
        var hashValerror = window.location.hash.substr(1);

        var error = hashValerror.split('&')[0].substr(0,5);
        if(error == "error")
        {                
            errorName = hashValerror.split('&')[0].split('=')[1];
            errorDesc = hashValerror.split('&')[1].split('=')[1];
            return { "error" : errorName, "desc": errorDesc };
        }
        return null;
    }

    $( document ).ready(function() {
        console.log( "ready!" );
        Init();
    });

    
    function Init(){
            var err = getErrorDetails();
        if(err != null)
        {
                $('#errortable tr:last').after('<tr><td>'+err.error+'</td><td>'+decodeURIComponent(err.desc).replace("+"," ")+'</td></tr>');
                $("#claimstable").hide();
                $("#logout").hide();
                $("#gettoken").hide();
                $("#home").show();


                return;
        }
        $('#errortable').hide();
            //$("#idTokenDiv").text(JSON.stringify(decodeClaims()));
        var resultJSON = decodeClaims();
        $.each(resultJSON, function(k, v) {
            $('#claimstable tr:last').after('<tr><td>'+k+'</td><td>'+v+'</td></tr>');
        });


        $.get("b2csettings.json", function(data){
            var url = "https://login.microsoftonline.com/"+data.tenant_name+"/oauth2/v2.0/token"+
            "?p="+data.policyName+
            "&grant_type=authorization_code"+
            "&scope=offline_access "+data.client_id+
            "&client_id="+data.client_id+
            "&redirect_uri="+data.redirect_uri+
            "&code="+getCode()+
            "&client_secret="+data.client_secret;
            $("#tokenForm").attr("action", url);
        });            
    }      

    </script>
    </head>
    <body>
    
    <a id="home" href="default.htm" style="display: none">Go to Home Page</a>
    
    <table>
        <tr>
            <td > 
                <button id="logout" style="margin-right: 20px" class="btn btn-default"  onclick="logout()">Logout</button>
            </td>            
            <td> 
                <form id="tokenForm" method="POST" action="">
                    <button id="gettoken" class="btn btn-default">Get Access Token</button>
                </form>
            </td>
   
        </tr>
    </table>
    
    <br>
    <div style="width:100%">
    <table id = "claimstable"  class="table table-striped" style="width:500px">
            <tr>
            <th>Claim Name</th>
            <th>Claim Value</th>
            </tr>
        <tbody>        
        </tbody>
    </table>

    <table id = "errortable"  class="table table-striped" style="width:500px">
            <tr>
            <th>Error</th>
            <th>Error Description</th>
            </tr>
        <tbody>        
        </tbody>
    </table>
    </div>
    </body>    
 </html>