<!DOCTYPE html>
<html> 
    <head><h3>Welcome</h3> 
    <style>
        html {
        display: table;
        margin: auto;
        }

        body {
            display: table-cell;
            vertical-align: middle;
        }
    </style>

    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="node_modules/jwt-decode/build/jwt-decode.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
            
    <script>
    
    function logout()
    {
        window.location = "https://login.microsoftonline.com/webscouttst.onmicrosoft.com/oauth2/v2.0/logout?p=B2C_1_Su_Jan20_DND"+
        "&post_logout_redirect_uri=https://localhost:855/default.htm";

    }

    function getState()
    {
        // my state returns the policy Name
       /* var hashVal = window.location.hash.substr(1);
        var state = hashVal..split('&')[0].substr(6);
        console.log(state);
        return state;*/

        return getParam("state", window.location.search);
    }

    function getCode()
    {
        /*var hashVal = window.location.hash.substr(1);
        var code = hashVal.split('&')[1].substr(5);
        console.log(code);
        return code;*/
        return getParam("code", window.location.search);
    }

    function decodeClaims()
    {
        var hashVal = window.location.hash.substr(1);
        console.log(hashVal);
        if(hashVal.indexOf("id_token") == -1)
        {
            return;
        }
        var idToken = hashVal.split('&')[1].substr(9);
        console.log(idToken);
        var decoded = jwt_decode(idToken);
        console.log(decoded);
        return decoded;

       /* var idToken = getParam("id_token", window.location.search );
        var decoded = jwt_decode(idToken);
        console.log(decoded);
        return decoded;*/


    }

    function getParam( name, url ) {
        if (!url) url = location.href;
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
        var regexS = "[\\?&]"+name+"=([^&#]*)";
        var regex = new RegExp( regexS );
        var results = regex.exec( url );
        return results == null ? null : results[1];
    }

    function getErrorDetails()
    {
        var hashValerror = window.location.hash.substr(1);

        var error = hashValerror.split('&')[0].substr(0,5);
        if(error == "error")
        {                
            errorName = hashValerror.split('&')[0].split('=')[1];
            errorDesc = hashValerror.split('&')[1].split('=')[1];
            return { "error" : errorName, "desc": errorDesc };
        }
        return null;
    }

    $( document ).ready(function() {
        console.log( "ready!" );
        Init();
    });

    
    function Init(){
            var err = getErrorDetails();
        if(err != null)
        {
                $('#errortable tr:last').after('<tr><td>'+err.error+'</td><td>'+decodeURIComponent(err.desc).replace("+"," ")+'</td></tr>');
                $("#claimstable").hide();
                $("#logout").hide();
                $("#gettoken").hide();
                $("#home").show();


                return;
        }
        $('#errortable').hide();
            //$("#idTokenDiv").text(JSON.stringify(decodeClaims()));
        var resultJSON = decodeClaims();
        $.each(resultJSON, function(k, v) {
            $('#claimstable tr:last').after('<tr><td>'+k+'</td><td>'+v+'</td></tr>');
        });

        $.get("b2csettings.json", function(data){
            var policyName = getState();
            $('#scope').val("https://webscouttst.onmicrosoft.com/dndresource/read");

            var url = "https://login.microsoftonline.com/"+data.tenant_name+"/oauth2/v2.0/token"+
            "?p="+policyName+
            "&grant_type=authorization_code"+
            "&scope="+   $('#scope').val()+
            "&client_id="+ data.client_id+
            "&redirect_uri="+data.redirect_uri+
            "&code="+getCode()+
            "&client_secret="+data.client_secret;
            $("#tokenForm").attr("action", url);
             });
    }      

     

        function getToken()
        {
            $.get("b2csettings.json", function(data){
            var policyName = getState();
            $('#scope').val("https://webscouttst.onmicrosoft.com/dndresource/read");

            var url = "https://login.microsoftonline.com/"+data.tenant_name+"/oauth2/v2.0/token"+
            "?p="+policyName+
            "&grant_type=authorization_code"+
            "&scope="+   $('#scope').val()+
            "&client_id="+ data.client_id+
            "&redirect_uri="+data.redirect_uri+
            "&code="+getCode()+
            "&client_secret="+data.client_secret;
            $("#tokenForm").attr("action", url);
             });
        }    

    </script>
    </head>
    <body>
    
    <a id="home" href="default.htm" style="display: none">Go to Home Page</a>
    <div class="form-group">
                    <label for="scope">Scope:</label>
                    <input type="text" class="form-control" id="scope">
                </div>
    <table>
        <tr>
            <td > 
                <button id="logout" style="margin-right: 20px" class="btn btn-default"  onclick="logout()">Logout</button>
            </td>     
            <td>
                
            </td>       
            <td> 
                <form id="tokenForm" method="POST" action="">
                    <button id="gettoken" class="btn btn-default" onclick="getToken()">Get Access Token</button>
                </form>
            </td>
   
        </tr>
    </table>
    
    <br>
    <div style="width:100%">
    <table id = "claimstable"  class="table table-striped" style="width:500px">
            <tr>
            <th>Claim Name</th>
            <th>Claim Value</th>
            </tr>
        <tbody>        
        </tbody>
    </table>

    <table id = "errortable"  class="table table-striped" style="width:500px">
            <tr>
            <th>Error</th>
            <th>Error Description</th>
            </tr>
        <tbody>        
        </tbody>
    </table>
    </div>
    </body>    
 </html>